/**
 * TikTok Description Generator v5.0
 * "Few-shot Learning Version"
 * 
 * ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:
 * - ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á + description ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏õ‡πá‡∏ô reference
 * - AI ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ "‡∏™‡πÑ‡∏ï‡∏•‡πå" ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏à‡∏≥‡∏Ñ‡∏≥
 * - ‡∏™‡πà‡∏á full dialogue ‡πÉ‡∏´‡πâ AI ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏á
 */

require('dotenv').config({ path: require('path').resolve(__dirname, '../../.env') });
const { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } = require('@google/generative-ai');

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

if (!GEMINI_API_KEY) {
    console.error('ERROR: GEMINI_API_KEY not found in .env file');
    process.exit(1);
}

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

/**
 * Generate 5 TikTok descriptions - Few-shot Learning Version
 */
async function generateDescriptions(dialogues, characters, roomName, theme) {
    try {
        console.log('üì± Generating TikTok descriptions (Few-shot Learning)...');
        
        const model = genAI.getGenerativeModel({ 
            model: 'gemini-2.0-flash',
            generationConfig: {
                temperature: 0.9,
                topK: 50,
                topP: 0.95,
            },
            safetySettings: [
                { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
            ],
        });

        // ‡∏™‡πà‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const fullDialogue = dialogues
            .filter(d => d.message && d.message.trim())
            .map(d => {
                const name = characters[d.sender]?.name || d.sender;
                return `${name}: ${d.message}`;
            })
            .join('\n');
        
        const dialogueText = fullDialogue.length > 2500 
            ? fullDialogue.substring(0, 2500) + '\n...'
            : fullDialogue;

        console.log('Dialogue length:', dialogueText.length, 'chars');

        // Reference story 1: ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡πÅ‡∏Å‡πâ‡∏ß"
        const referenceStory1 = `‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏ô‡∏ô‡∏ô
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏ô‡πÄ‡∏ô‡∏µ‡πà‡∏¢‡∏¢‡∏¢ ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏¢‡∏¢‡∏¢
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏°‡∏µ‡πÑ‡∏£ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ö‡∏≠‡∏Å‡πÑ‡∏õ‡∏ß‡πà‡∏≤‡∏û‡∏µ‡πà‡∏ä‡∏¥‡∏ï‡πÅ‡∏•‡πâ‡∏ß
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏ô‡∏ô
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏ô‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡∏°‡∏≠‡∏∞!!!
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏ó‡∏≥‡πÑ‡∏° ‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏™‡πà‡∏á‡∏≠‡πà‡∏≠
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏°‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ß ‡πÅ‡∏ï‡πà‡∏û‡∏µ‡πà‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏£
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏Å‡πá‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏µ‡πà‡∏î‡∏¥
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ú‡∏¥‡∏î!!!! ‡∏û‡∏µ‡πà‡πÉ‡∏™‡πà‡∏ß‡πà‡∏≤ "‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å" !!!!!!
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ...
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏ä‡∏´ ‡∏•‡∏∞
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠... ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏Å‡∏î‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏°‡∏µ‡∏¢
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÇ‡∏≠‡πä‡∏¢‡∏¢‡∏¢ ‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏û‡∏û ‡∏´‡∏≤‡∏ó‡∏≥‡∏°‡∏≤‡∏Å‡πÅ‡∏°‡πà
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ‡∏û‡∏µ‡πà‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏≤‡∏ñ‡∏∂‡∏á ‡∏ï‡∏∞‡πÇ‡∏Å‡∏ô‡∏•‡∏±‡πà‡∏ô‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡πÄ‡∏•‡∏¢
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: "‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ä‡∏≤‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å‡∏á‡πâ‡∏≠‡πÅ‡∏ü‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡πâ‡∏≤‡∏ö‡∏ö‡∏ö!!"
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏Ñ‡∏ô‡∏°‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏ô ‡∏û‡∏µ‡∏Ñ‡∏Ñ‡∏Ñ‡∏Ñ
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: 55555555555
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÇ‡∏ó‡∏î‡πÜ ‡∏°‡∏∑‡∏≠‡∏•‡∏±‡πà‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏≠‡∏¢
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö‡∏ö‡∏ö ‡∏û‡∏µ‡πà‡πÅ‡∏Å‡πÄ‡∏ó‡∏®‡∏ô‡∏≤‡∏´‡∏ô‡∏π‡∏¢‡∏≤‡∏ß‡∏°‡∏≤‡∏Å‡∏Å‡∏Å
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ö‡∏≠‡∏Å‡∏´‡∏ô‡∏π‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡πÜ ‡∏ú‡∏±‡∏ß‡∏≠‡∏∏‡∏ï‡∏™‡πà‡∏≤‡∏´‡πå‡∏á‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏î‡∏µ‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏´‡∏ô‡∏π‡∏à‡∏∞‡∏ö‡πâ‡∏≤‡∏≤‡∏≤ ‡∏´‡∏ô‡∏π‡πÇ‡∏™‡∏î‡∏Ñ‡πà‡∏≤‡∏≤‡∏≤‡∏≤‡∏≤!!!
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÄ‡∏ä‡∏£‡∏î‡∏î‡∏î‡∏î ‡∏î‡∏±‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏•‡∏∞‡πÄ‡∏£‡∏≤
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏¢‡∏¢‡∏¢ ‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏•‡∏¢‡∏¢‡∏¢‡∏¢
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: [‡∏Å‡∏î‡∏ä‡∏±‡∏Å‡πÇ‡∏Ñ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡∏•‡πâ‡∏á‡∏ï‡∏∏‡∏¢]`;

        const referenceDesc1 = `‡∏ß‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πà‡∏ß‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®, ‡∏Å‡∏£‡∏≤‡∏ö‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡πÑ‡∏£‡πÄ‡∏î‡∏≠‡∏£‡πå, ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡πÅ‡∏ô‡πà, ‡∏ä‡∏≤‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å‡∏û‡∏≤‡∏ã‡∏ß‡∏¢, ‡∏î‡∏±‡∏á‡πÄ‡∏•‡∏¢‡∏ó‡∏µ‡∏ô‡∏µ‡πâ, ‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏π‡∏ô‡πâ‡∏≠‡∏á‡∏á‡∏á`;

        // Reference story 2: ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "Art Toy ‡∏ï‡πâ‡∏°"
        const referenceStory2 = `‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô ‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ã‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß‡∏õ‡πà‡∏∞
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡πÑ‡∏£‡πÉ‡∏™‡πà‡∏ó‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏ß‡∏±‡∏ô
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡∏´‡∏ô‡∏π‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô‡∏°‡∏∞‡∏û‡∏µ‡πà
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ß‡πà‡∏≤ "‡∏ô‡πâ‡∏≠‡∏á‡πÑ‡∏Ç‡πà‡∏î‡∏¥‡πà‡∏á" ‡∏≠‡∏∞
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏∞
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏Ç‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡πâ‡∏°‡πÜ ‡∏ä‡∏±‡πâ‡∏ô 2
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÄ‡∏•‡∏¢‡∏à‡∏±‡∏ö‡∏•‡∏á‡∏´‡∏°‡πâ‡∏≠‡∏ï‡πâ‡∏°‡∏•‡∏∞ ‡∏´‡∏¥‡∏ß‡πÑ‡∏™‡πâ‡∏Å‡∏¥‡πà‡∏ß
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ...
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î‡∏õ‡πà‡∏∞...
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÅ‡∏°‡πà‡∏ô
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏™‡∏µ‡∏â‡∏π‡∏î‡∏â‡∏≤‡∏î‡∏î‡∏µ ‡∏ô‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏Ç‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏ß‡∏°‡πâ‡∏≤ OTOP
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏Å‡∏£‡∏µ‡πä‡∏î‡∏î‡∏î‡∏î‡∏î‡∏î‡∏î‡∏î‡∏î‡∏î‡∏î‡∏î‡∏î
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏û‡∏£‡∏µ‡πà!!!!!!!!!!!!
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ô‡∏±‡πà‡∏ô‡∏°‡∏±‡∏ô Art Toy ‡∏¢‡πà‡∏∞!!! ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡∏ô‡∏ô‡∏ô
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏î‡∏±‡∏ö‡πÑ‡∏ü‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ‡∏ô‡∏∞! ‡πÇ‡∏≠‡πâ‡∏¢‡∏¢‡∏¢ ‡∏™‡∏†‡∏≤‡∏û‡∏û‡∏û‡∏û
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏≠‡πâ‡∏≤‡∏ß
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏° 10 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏∏‡∏Å
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÅ‡∏ñ‡∏°‡∏Å‡∏•‡∏¥‡πà‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏¢‡∏≤‡∏á‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡πÑ‡∏´‡∏°‡πâ
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏°‡πâ‡∏≠‡∏≠‡∏≠‡∏≠‡∏≠‡∏≠
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ï‡∏±‡∏ß Secret ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡πÄ‡∏ß‡πâ‡∏¢‡∏¢‡∏¢
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: 5 ‡∏û‡∏±‡∏ô‡∏ô‡∏∞‡∏ô‡∏±‡πà‡∏ô‡∏ô‡πà‡∏∞!
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: 5 ‡∏û‡∏±‡∏ô?
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏û‡∏µ‡πà 3 ‡∏ß‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏ô‡∏∞
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÄ‡∏•‡∏¢ ‡∏ô‡∏≠‡∏¢‡∏≠‡πà‡∏≤‡∏≤ T^T
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏≠‡∏¢‡∏≤‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å...
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÑ‡∏°‡πà‡∏´‡∏ô‡∏µ ‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: [‡πÅ‡∏Å‡∏•‡πâ‡∏á‡∏ä‡∏±‡∏Å‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å‡∏Ñ‡∏≤‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß]`;

        const referenceDesc2 = `‡∏ï‡πâ‡∏°‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÑ‡∏á‡∏Å‡πà‡∏≠‡∏ô, ‡∏ô‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô, ‡∏°‡∏≠‡∏á‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏•‡∏¢‡πÄ‡∏ô‡∏µ‡πà‡∏¢, ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¥‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏´‡∏ï‡∏∏, ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏¢‡∏≤‡∏á‡πÄ‡∏ï‡∏∞‡∏à‡∏°‡∏π‡∏Å‡πÄ‡∏•‡∏¢‡∏¢‡∏¢, ‡∏ï‡πâ‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡∏∏‡∏Å‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á‡∏á‡∏á`;

        // Reference story 3: ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡πà‡∏á‡∏ú‡∏¥‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°" (‡πÅ‡∏ô‡∏ß‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤/‡∏´‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô)
        const referenceStory3 = `‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô‡∏ô‡∏ô‡∏ô!!!
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏£‡∏µ‡∏ö‡∏´‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏µ‡πà
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ‡∏ô‡∏ô‡∏ô‡∏ô
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÑ‡∏£‡πÄ‡∏ô‡∏µ‡πà‡∏¢
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ô‡∏≠‡∏ô
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß!
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏û‡∏µ‡πà‡∏£‡∏µ‡∏ö‡πÄ‡∏ä‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏î‡πà‡∏ß‡∏ô
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ô‡∏∏‡πâ‡∏á‡∏ó‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏Å‡∏Å
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏£‡πÑ‡∏ß‡πâ‡∏≠‡∏µ‡∏Å
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡πÄ‡∏ß‡πâ‡∏¢
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏Ñ‡∏∑‡∏≠‡∏ô‡∏∏‡πâ‡∏á‡πÅ‡∏≠‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏µ‡πà‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö HR
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ï‡∏≠‡∏ô‡∏ô‡∏≤‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏¥‡∏ô‡∏ó‡∏≤‡∏û‡∏µ‡πà‡∏â‡πà‡∏≥‡πÜ
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏Å‡∏∞‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏°‡∏Ñ‡πå
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏î‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏•‡∏±‡πà‡∏ô‡∏Å‡∏î‡∏ú‡∏¥‡∏î‡∏•‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° All Staff ‡∏≠‡∏∞‡πÅ‡∏°‡πà!!!
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: Unsend ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏ö TT
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ...
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏î‡πà‡∏≤‡∏ß‡πà‡∏≤‡πÑ‡∏á
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å!
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ô‡∏≤‡∏á‡∏î‡πà‡∏≤‡∏û‡∏µ‡πà‡∏ß‡πà‡∏≤ "‡πÑ‡∏≠‡πâ‡∏•‡∏π‡∏Å‡πÅ‡∏´‡∏á‡πà‡πÄ‡∏Å‡∏≤‡∏∞‡πÅ‡∏°‡πà‡∏Å‡∏¥‡∏ô"
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: "‡πÇ‡∏ï‡∏à‡∏ô‡∏õ‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏á‡πÉ‡∏ô‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Å"
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: "‡∏ß‡∏±‡∏ô‡πÜ ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏´‡πà‡∏≤‡πÑ‡∏£‡∏î‡∏µ‡πÅ‡∏ï‡πà‡∏ú‡∏•‡∏≤‡∏ç‡πÄ‡∏á‡∏¥‡∏ô"
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: Toxic ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏õ‡πà‡∏∞‡∏û‡∏µ‡πà
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏ü‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏°‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏°‡∏∞
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏∏‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ô‡πÉ‡∏´‡πâ ‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á!
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏û‡∏µ‡∏ä
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏°‡∏∂‡∏á‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÄ‡∏¢‡πá‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡∏•‡∏∞! ‡∏´‡∏¢‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏®‡∏£‡∏µ‡∏•‡∏π‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡πâ‡∏ô‡∏∞‡πÄ‡∏ß‡πâ‡∏¢
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏™‡∏π‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏ô‡∏±‡πà‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà HR ‡∏ö‡∏π‡∏•‡∏•‡∏µ‡πà
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡∏ô‡∏±‡πà‡∏ô‡πÅ‡∏°‡πà‡∏Å‡∏π
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ...
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏´‡∏∂?
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏¥
‡∏û‡∏µ‡πà‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö HR: @Ton ‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢‡πÅ‡∏°‡πà‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞
‡∏û‡∏µ‡πà‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö HR: ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏µ‡∏ä...
‡∏û‡∏µ‡πà‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö HR: ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞ ^^
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏™‡∏π‡πâ‡∏ä‡∏¥‡∏ï...
‡∏ô‡∏∏‡πâ‡∏á‡∏û‡∏µ‡∏ä: ‡∏¢‡πâ‡∏≤‡∏¢‡∏î‡∏≤‡∏ß‡πÅ‡∏õ‡∏õ
‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏ô: ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ô‡∏∞`;

        const referenceDesc3 = `‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏ß‡∏ß‡∏ß‡∏ß, ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á‡∏ö‡∏∏‡∏ç‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡∏û‡∏µ‡∏ä‡∏ó‡∏µ, ‡∏û‡∏µ‡∏ä‡πÄ‡∏≠‡πâ‡∏¢‡∏¢‡∏¢ ‡∏û‡∏µ‡∏ä, ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏£‡∏Å, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏à‡πá‡∏ö‡∏õ‡∏ß‡∏î‡∏Å‡∏ß‡πà‡∏≤, ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡πÄ‡∏•‡∏¢, ‡∏ï‡∏±‡∏ß‡∏ï‡∏∂‡∏á‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á`;

        // Detect mood from dialogue
        const allText = dialogues.map(d => d.message || '').join(' ');
        let mood = '‡∏ï‡∏•‡∏Å/‡∏Ç‡∏≥‡πÜ';
        if (allText.match(/‡∏ú‡∏µ|‡∏´‡∏•‡∏≠‡∏ô|‡∏Å‡∏•‡∏±‡∏ß|‡∏™‡∏¢‡∏≠‡∏á|‡∏Ç‡∏ô‡∏•‡∏∏‡∏Å/)) mood = '‡∏™‡∏¢‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç/‡∏´‡∏•‡∏≠‡∏ô';
        else if (allText.match(/‡πÇ‡∏Å‡∏£‡∏ò|‡∏î‡πà‡∏≤|‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î|‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏î|toxic|‡∏ö‡∏π‡∏•‡∏•‡∏µ‡πà/i)) mood = '‡∏´‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô/‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤';
        else if (allText.match(/‡∏£‡∏±‡∏Å|‡∏´‡∏ß‡∏≤‡∏ô|‡∏ä‡∏≠‡∏ö|‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á|‡πÄ‡∏Ç‡∏¥‡∏ô‡πÄ‡∏•‡∏¢/)) mood = '‡∏´‡∏ß‡∏≤‡∏ô/‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å';
        else if (allText.match(/‡πÄ‡∏®‡∏£‡πâ‡∏≤|‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ|‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à|‡∏ô‡πâ‡∏≥‡∏ï‡∏≤/)) mood = '‡πÄ‡∏®‡∏£‡πâ‡∏≤/‡∏ã‡∏∂‡πâ‡∏á';

        const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô TikTok ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ chat story

‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 3 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô:

=== ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 1 (‡πÅ‡∏ô‡∏ß‡∏ï‡∏•‡∏Å) ===
‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡πÅ‡∏Å‡πâ‡∏ß
‡πÅ‡∏ä‡∏ó:
${referenceStory1}

‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ: ${referenceDesc1}

=== ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 2 (‡πÅ‡∏ô‡∏ß‡∏ï‡∏•‡∏Å) ===
‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°‡∏´‡πâ‡∏≤‡∏û‡∏±‡∏ô
‡πÅ‡∏ä‡∏ó:
${referenceStory2}

‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ: ${referenceDesc2}

=== ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 3 (‡πÅ‡∏ô‡∏ß‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤/‡∏´‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô) ===
‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡πà‡∏á‡∏ú‡∏¥‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
‡πÅ‡∏ä‡∏ó:
${referenceStory3}

‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ: ${referenceDesc3}

=== ‡∏à‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ===

‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ:

‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${roomName || '‡πÅ‡∏ä‡∏ó'}
‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå/‡πÇ‡∏ó‡∏ô: ${mood}

‡πÅ‡∏ä‡∏ó:
${dialogueText}

---

‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô 5 ‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ "‡∏™‡πÑ‡∏ï‡∏•‡πå" ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
- ‡∏™‡∏±‡πâ‡∏ô‡πÜ 3-7 ‡∏Ñ‡∏≥
- ‡∏´‡πâ‡∏≤‡∏° emoji
- ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
- ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏´‡∏¢‡∏≤‡∏ö
- ‡∏´‡πâ‡∏≤‡∏° spoil ‡∏ï‡∏≠‡∏ô‡∏à‡∏ö
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡πá‡∏≠‡∏õ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á

‡∏ï‡∏≠‡∏ö JSON:
{"descriptions": ["‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô1", "‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô2", "‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô3", "‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô4", "‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô5"]}`;

        const result = await model.generateContent(prompt);
        const response = result.response.text();
        
        // Parse JSON
        let jsonText = response.replace(/```json\n?/gi, '').replace(/```\n?/g, '');
        const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
        
        if (!jsonMatch) {
            console.error('AI Response:', response);
            throw new Error('Failed to parse AI response');
        }
        
        const parsed = JSON.parse(jsonMatch[0]);
        
        // ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ
        const badPatterns = [
            /‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡∏á‡∏≥/, /‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤/, /‡∏û‡∏•‡∏¥‡∏Å‡∏ú‡∏±‡∏ô/, /‡∏Ñ‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á/,
            /‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô/, /‡∏û‡∏µ‡∏Ñ/, /‡∏ó‡∏¥‡∏û‡∏¢‡πå/, /‡∏ö‡∏ó‡πÉ‡∏´‡∏°‡πà/,  // ‡∏ü‡∏±‡∏á AI
            /‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏¥‡∏î/, /‡∏ä‡∏∑‡πà‡∏≠.*‡∏ú‡∏¥‡∏î/,  // ‡∏™‡∏õ‡∏≠‡∏¢
            /‡∏ä‡∏≤‡∏ö‡∏π/,  // ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß
            /‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô$/,  // ‡∏•‡∏≠‡∏¢‡πÜ ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î
            /‡∏ï‡∏≤‡∏¢/, /‡∏ö‡∏±‡∏î‡∏ã‡∏ö/, /‡∏´‡πà‡∏≤/, /‡πÄ‡∏´‡∏µ‡πâ‡∏¢/,  // ‡∏´‡∏¢‡∏≤‡∏ö/‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
            /‡∏Å‡∏π|‡∏°‡∏∂‡∏á|‡∏™‡∏±‡∏ï‡∏ß‡πå/,
        ];
        
        // ‡πÅ‡∏õ‡∏•‡∏á array ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô format ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        let descriptions = [];
        if (Array.isArray(parsed.descriptions)) {
            const usedTexts = new Set();
            
            descriptions = parsed.descriptions.map((item, idx) => {
                // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á string ‡πÅ‡∏•‡∏∞ object
                let text = typeof item === 'string' ? item : item.text;
                text = text
                    .replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '')
                    .replace(/[?Ôºü]$/g, '')
                    .replace(/\(.*?\)/g, '')  // ‡∏•‡∏ö‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö
                    .trim();
                
                // ‡∏ï‡∏£‡∏ß‡∏à bad patterns ‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡πâ‡∏≥
                const hasBadPattern = badPatterns.some(pattern => pattern.test(text));
                const isDuplicate = usedTexts.has(text.toLowerCase());
                
                if (hasBadPattern || isDuplicate) {
                    const availableFallbacks = FALLBACK_POOL.filter(f => !usedTexts.has(f.toLowerCase()));
                    text = availableFallbacks[Math.floor(Math.random() * availableFallbacks.length)] || FALLBACK_POOL[idx];
                }
                
                usedTexts.add(text.toLowerCase());
                
                return {
                    id: idx + 1,
                    text: text,
                    wordCount: text.split(/\s+/).length
                };
            });
        }
        
        return {
            success: true,
            descriptions: descriptions,
            analysis: { mood: '‡∏ï‡∏•‡∏Å' }
        };
        
    } catch (err) {
        console.error('‚ùå Description generation FAILED:', err);
        return {
            success: false,
            error: err.message,
            descriptions: []
        };
    }
}

module.exports = {
    generateDescriptions
};
